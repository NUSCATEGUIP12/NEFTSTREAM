<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema NeftStream</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      background-color: #121212;
      color: white;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    input, button, select, textarea {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box;
      background-color: #1e1e1e;
      color: white;
      border: none;
    }
    button {
      background-color: red;
      font-weight: bold;
    }
    button:hover {
      background-color: darkred;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border: 1px solid #333;
    }
    th {
      background-color: #333;
    }
    #app {
      display: none;
    }
  </style>
</head>
<body>

<div id="login">
  <h2>üîê Iniciar sesi√≥n</h2>
  <input type="text" id="usuario" placeholder="Usuario">
  <input type="password" id="clave" placeholder="Contrase√±a">
  <button onclick="autenticar()">Entrar</button>
  <p id="errorLogin" style="color:red;"></p>
</div>

<div id="app">
  <h2>üé¨ Generador NeftStream</h2>

  <label>Correo:</label>
  <input type="email" id="correo" placeholder="Pega el correo aqu√≠">

  <label>Contrase√±a:</label>
  <input type="text" id="contrasena" placeholder="Pega la contrase√±a aqu√≠">

  <label>Estado de pago:</label>
  <select id="estadoPago">
    <option value="Debe">Debe</option>
    <option value="Pag√≥">Pag√≥</option>
  </select>

  <button onclick="generar()">Generar Mensaje</button>

  <textarea id="mensaje" readonly></textarea>
  <button onclick="copiar()">üìã Copiar Mensaje</button>
  <button onclick="exportarMes()">üì§ Exportar a Excel</button>

  <br><br>
  <label>üì• Importar archivo Excel para actualizar pagos:</label>
  <input type="file" id="archivoExcel" accept=".xlsx" onchange="importarPagos()">

  <div style="margin-top: 20px;">
    <label>Filtrar por estado:</label>
    <select id="filtroEstado" onchange="actualizarTabla()">
      <option value="">Todos</option>
      <option value="Debe">Debe</option>
      <option value="Pag√≥">Pag√≥</option>
    </select>

    <label>Filtrar por usuario:</label>
    <select id="filtroUsuario" onchange="actualizarTabla()">
      <option value="">Todos</option>
      <option value="Sneider">Sneider</option>
      <option value="Jaidith">Jaidith</option>
      <option value="Neftali">Neftali</option>
      <option value="ADMIN">ADMIN</option>
    </select>

    <label>Filtrar por correo:</label>
    <input type="text" id="filtroCorreo" onkeyup="actualizarTabla()" placeholder="Buscar correo...">

    <button onclick="generarResumen()">Ver resumen</button>
    <button onclick="exportarResumenPDF()">Exportar resumen PDF</button>
    <div id="resumen" style="margin-top: 10px; background:#1e1e1e; padding:10px; border-radius:5px;"></div>
  </div>

  <h3>üìÖ Registros del mes actual</h3>
  <table>
    <thead>
      <tr>
        <th>Correo</th>
        <th>Contrase√±a</th>
        <th>Perfil</th>
        <th>Generado por</th>
        <th>Estado</th>
        <th>Fecha</th>
      </tr>
    </thead>
    <tbody id="tabla"></tbody>
  </table>
</div>

<script>
const usuarios = {
  Sneider: "000111",
  Jaidith: "2000",
  Neftali: "1004822917",
  ADMIN: "1004822917"
};

let usuarioActivo = "";
let registros = JSON.parse(localStorage.getItem("neftstreamRegistros")) || {};

function obtenerMesActual() {
  const d = new Date();
  return d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0");
}

function autenticar() {
  const u = document.getElementById("usuario").value.trim();
  const p = document.getElementById("clave").value.trim();
  if (usuarios[u] === p) {
    usuarioActivo = u;
    document.getElementById("login").style.display = "none";
    document.getElementById("app").style.display = "block";
    actualizarTabla();
  } else {
    document.getElementById("errorLogin").innerText = "Credenciales incorrectas.";
  }
}

function generar() {
  const correo = document.getElementById("correo").value.trim();
  const contrasena = document.getElementById("contrasena").value.trim();
  const estado = document.getElementById("estadoPago").value;
  const mes = obtenerMesActual();
  const fecha = new Date().toLocaleString();

  if (!correo || !contrasena) {
    alert("Debe ingresar correo y contrase√±a.");
    return;
  }

  if (!registros[mes]) registros[mes] = [];

  const perfilesUsados = registros[mes].filter(r => r.correo === correo).map(r => r.perfil);
  let perfilDisponible = null;
  for (let i = 1; i <= 5; i++) {
    if (!perfilesUsados.includes(i)) {
      perfilDisponible = i;
      break;
    }
  }

  if (!perfilDisponible) {
    alert("Este correo ya tiene 5 perfiles asignados este mes.");
    return;
  }

  const pin = 2010 + perfilDisponible;
  const mensaje = `üé¨ *Pantalla de Netflix Activa* üé¨\n\nüìß *Correo:* ${correo}\nüîë *Contrase√±a:* ${contrasena}\nüßèüèΩ‚Äç‚ôÇÔ∏è *Perfil:* ${perfilDisponible}\nüîí *PIN de Acceso:* ${pin}\n\n‚ú® *Importante:* No compartir o cambiar contrase√±as para evitar suspensi√≥n de la cuenta üåü. ¬°Disfruta de tu contenido! üçøüé¨üéâ\n\n‚Äî\n‚úÖ *¬°Muchas gracias por tu compra!* \nüõí Esperamos que disfrutes de tu pantallaüì∫üçø\nCualquier duda, estamos aqu√≠ para ayudarte.\n¬°Que disfrutes de tu suscripci√≥n! üé¨üòä\n\nEncuentra m√°s ofertas aqu√≠:\nüëâ https://neftaliuscategui.com`;

  document.getElementById("mensaje").value = mensaje;

  registros[mes].push({ correo, contrasena, perfil: perfilDisponible, operador: usuarioActivo, estado, fecha });
  localStorage.setItem("neftstreamRegistros", JSON.stringify(registros));
  actualizarTabla();
}

function copiar() {
  const txt = document.getElementById("mensaje");
  txt.select();
  document.execCommand("copy");
  alert("Mensaje copiado.");
}

function actualizarTabla() {
  const mes = obtenerMesActual();
  const estadoFiltro = document.getElementById("filtroEstado").value;
  const usuarioFiltro = document.getElementById("filtroUsuario").value;
  const correoFiltro = document.getElementById("filtroCorreo").value.toLowerCase();
  const tbody = document.getElementById("tabla");
  tbody.innerHTML = "";

  (registros[mes] || []).filter(r => {
    return (!estadoFiltro || r.estado === estadoFiltro) &&
           (!usuarioFiltro || r.operador === usuarioFiltro) &&
           (!correoFiltro || r.correo.toLowerCase().includes(correoFiltro));
  }).forEach((r, i) => {
    const color = r.estado === "Debe" ? "#801f1f" : "#1f8034";
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${r.correo}</td>
      <td>${r.contrasena}</td>
      <td>${r.perfil}</td>
      <td>${r.operador}</td>
      <td style="background-color:${color}">${r.estado}</td>
      <td>${r.fecha}</td>
    `;
    tbody.appendChild(row);
  });
}

function generarResumen() {
  const mes = obtenerMesActual();
  const datos = registros[mes] || [];
  const resumen = {};
  let totalDeuda = 0;

  datos.forEach(r => {
    if (!resumen[r.operador]) resumen[r.operador] = { total: 0, debe: 0 };
    resumen[r.operador].total++;
    if (r.estado === "Debe") {
      resumen[r.operador].debe++;
      totalDeuda += 9000;
    }
  });

  let html = `<ul>`;
  for (const user in resumen) {
    const reg = resumen[user];
    html += `<li><b>${user}</b>: ${reg.total} perfiles | ${reg.debe} debe = $${reg.debe * 9000}</li>`;
  }
  html += `</ul><p><b>Total a deber:</b> $${totalDeuda}</p>`;
  document.getElementById("resumen").innerHTML = html;
}

function exportarResumenPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(12);
  doc.text("Resumen de Deudas NeftStream", 10, 10);
  const resumen = document.getElementById("resumen").innerText.split("\n");
  resumen.forEach((linea, i) => {
    doc.text(linea, 10, 20 + (i * 8));
  });
  const fecha = new Date().toISOString().split("T")[0];
  doc.save(`resumen_neftstream_${fecha}.pdf`);
}

function exportarMes() {
  const mes = obtenerMesActual();
  const data = [["Correo", "Contrase√±a", "Perfil", "Operador", "Estado", "Fecha"]];
  (registros[mes] || []).forEach(r => {
    data.push([r.correo, r.contrasena, r.perfil, r.operador, r.estado, r.fecha]);
  });
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, mes);
  XLSX.writeFile(wb, `neftstream_${mes}.xlsx`);
}

function importarPagos() {
  const mes = obtenerMesActual();
  const file = document.getElementById("archivoExcel").files[0];
  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const datos = XLSX.utils.sheet_to_json(sheet);
    datos.forEach(row => {
      const index = (registros[mes] || []).findIndex(r => r.correo === row["Correo"] && r.perfil == row["Perfil"]);
      if (index !== -1) {
        registros[mes][index].estado = row["Estado"];
        if (row["Contrase√±a"]) registros[mes][index].contrasena = row["Contrase√±a"];
      }
    });
    localStorage.setItem("neftstreamRegistros", JSON.stringify(registros));
    actualizarTabla();
    alert("Pagos actualizados.");
  };
  reader.readAsArrayBuffer(file);
}
</script>

</body>
</html>
